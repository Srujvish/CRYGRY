name: Institutional Flow Detection

on:
  workflow_dispatch:
    inputs:
      run_hours:
        description: 'Monitoring duration (hours)'
        required: false
        default: '6'
      check_interval:
        description: 'Check frequency (seconds)'
        required: false
        default: '60'

env:
  PYTHON_VERSION: '3.10'
  SYSTEM_KEY: ${{ secrets.SYSTEM_KEY }}
  SYSTEM_SECRET: ${{ secrets.SYSTEM_SECRET }}
  ALERT_TOKEN: ${{ secrets.ALERT_TOKEN }}
  ALERT_TARGET: ${{ secrets.ALERT_TARGET }}

jobs:
  detect-flows:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 8 hours max
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Verify installation
      run: |
        echo "ðŸ”§ Verifying packages..."
        python -c "
        import pandas as pd
        import numpy as np
        import sklearn
        print(f'âœ… pandas {pd.__version__}')
        print(f'âœ… numpy {np.__version__}')
        print(f'âœ… sklearn {sklearn.__version__}')
        "
        
    - name: Start Institutional Flow Detection
      run: |
        echo "ðŸ›ï¸ INSTITUTIONAL FLOW DETECTION STARTED"
        echo "â±ï¸ Duration: ${{ github.event.inputs.run_hours }} hours"
        echo "â° Interval: ${{ github.event.inputs.check_interval }} seconds"
        echo "ðŸ• Start: $(date '+%H:%M:%S') UTC"
        echo ""
        echo "ðŸŽ¯ Detecting:"
        echo "â€¢ LARGE ACCUMULATION (like CE)"
        echo "â€¢ LARGE DISTRIBUTION (like PE)"
        echo "â€¢ STOP HUNT REVERSALS"
        echo "â€¢ LIQUIDITY GRABS"
        echo ""
        
        start_time=$(date +%s)
        end_time=$((start_time + ${{ github.event.inputs.run_hours }} * 3600))
        
        iteration=0
        
        while [ $(date +%s) -lt $end_time ]; do
          iteration=$((iteration + 1))
          current_time=$(date '+%H:%M:%S')
          echo ""
          echo "ðŸ”„ Flow Analysis #$iteration at $current_time UTC"
          echo "----------------------------------------"
          
          # Run the institutional flow detection
          python flow_detector.py
          
          # Calculate remaining time
          remaining=$((end_time - $(date +%s)))
          hours=$((remaining / 3600))
          minutes=$(((remaining % 3600) / 60))
          
          echo "â³ Next check in ${{ github.event.inputs.check_interval }} seconds"
          echo "â±ï¸ Remaining: ${hours}h ${minutes}m"
          
          # Wait for next check
          if [ $remaining -gt ${{ github.event.inputs.check_interval }} ]; then
            sleep ${{ github.event.inputs.check_interval }}
          fi
        done
        
        echo ""
        echo "âœ… Institutional flow detection completed"
        echo "ðŸ• End: $(date '+%H:%M:%S') UTC"
        echo "ðŸ” Total iterations: $iteration"
        
    - name: Create session report
      if: always()
      run: |
        echo "ðŸ“‹ Session Report" > flow_report.txt
        echo "================" >> flow_report.txt
        echo "Start: $(date -d @$start_time '+%Y-%m-%d %H:%M:%S') UTC" >> flow_report.txt
        echo "End: $(date '+%Y-%m-%d %H:%M:%S') UTC" >> flow_report.txt
        echo "Duration: ${{ github.event.inputs.run_hours }} hours" >> flow_report.txt
        echo "Iterations: $iteration" >> flow_report.txt
        echo "Status: ${{ job.status }}" >> flow_report.txt
        cat flow_report.txt
        
    - name: Upload session report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: flow-detection-report
        path: flow_report.txt
        retention-days: 7
