name: Pattern Detection Monitor

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      run_hours:
        description: 'Monitoring duration (hours)'
        required: false
        default: '6'
      scan_interval:
        description: 'Scan interval (seconds)'
        required: false
        default: '60'
      symbol_count:
        description: 'Number of symbols to analyze'
        required: false
        default: '8'

env:
  PYTHON_VERSION: '3.10'
  API_KEY: ${{ secrets.API_KEY }}
  API_SECRET: ${{ secrets.API_SECRET }}
  BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
  CHAT_ID: ${{ secrets.CHAT_ID }}

jobs:
  monitor-patterns:
    runs-on: ubuntu-latest
    timeout-minutes: 480  # 8 hours maximum

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install numpy pandas scikit-learn joblib requests
        
    - name: Start Pattern Detection Session
      run: |
        echo "ðŸš€ Starting Pattern Detection Session"
        echo "â±ï¸  Duration: ${{ github.event.inputs.run_hours }} hours"
        echo "ðŸ” Symbols: ${{ github.event.inputs.symbol_count }}"
        echo "â° Interval: ${{ github.event.inputs.scan_interval }} seconds"
        echo "ðŸ• Start time: $(TZ='UTC' date '+%H:%M:%S') UTC"
        
        start_time=$(date +%s)
        end_time=$((start_time + ${{ github.event.inputs.run_hours }} * 3600))
        
        iteration=0
        
        while [ $(date +%s) -lt $end_time ]; do
          iteration=$((iteration + 1))
          current_time=$(TZ='UTC' date '+%H:%M:%S')
          echo ""
          echo "ðŸ”„ Run #$iteration at $current_time UTC"
          echo "------------------------"
          
          # Run the pattern detection
          python ultimate_algo.py
          
          echo "âœ… Run #$iteration completed"
          
          # Calculate remaining time
          current_seconds=$(date +%s)
          remaining_seconds=$((end_time - current_seconds))
          remaining_hours=$((remaining_seconds / 3600))
          remaining_minutes=$(((remaining_seconds % 3600) / 60))
          
          if [ $remaining_seconds -gt ${{ github.event.inputs.scan_interval }} ]; then
            echo "â³ Next scan in ${{ github.event.inputs.scan_interval }} seconds"
            sleep ${{ github.event.inputs.scan_interval }}
          fi
        done
        
        echo ""
        echo "âœ… Session completed"
        echo "ðŸ“Š Total scans: $iteration"
        echo "â±ï¸  Duration: ${{ github.event.inputs.run_hours }} hours"
        echo "ðŸ• End time: $(TZ='UTC' date '+%H:%M:%S') UTC"
        
    - name: Save session report
      if: always()
      run: |
        echo "ðŸ“‹ Session Report" > session_report.txt
        echo "=================" >> session_report.txt
        echo "Start: $(TZ='UTC' date -d @$start_time '+%Y-%m-%d %H:%M:%S') UTC" >> session_report.txt
        echo "End: $(TZ='UTC' date '+%Y-%m-%d %H:%M:%S') UTC" >> session_report.txt
        echo "Duration: ${{ github.event.inputs.run_hours }} hours" >> session_report.txt
        echo "Status: ${{ job.status }}" >> session_report.txt
        cat session_report.txt
        
    - name: Upload session report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: session-report
        path: session_report.txt
